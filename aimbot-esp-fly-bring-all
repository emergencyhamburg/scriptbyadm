-- ULTRA TOOL v2.1 â€“ LocalScript sans admin, auto-GUI
-- TP et Bring ciblent un joueur via pseudo entrÃ© dans la TextBox

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")

local player = Players.LocalPlayer

-- GUI setup
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "UltraToolGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 300, 0, 420)
frame.Position = UDim2.new(0, 10, 1, -430) -- bas gauche
frame.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local layout = Instance.new("UIListLayout", frame)
layout.Padding = UDim.new(0, 8)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local function createButton(text)
    local b = Instance.new("TextButton", frame)
    b.Size = UDim2.new(0.9, 0, 0, 40)
    b.BackgroundColor3 = Color3.fromRGB(20, 20, 70)
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 16
    b.BorderSizePixel = 0
    b.Text = text
    return b
end

local flyBtn = createButton("ðŸ›« Fly (V)")
local espBtn = createButton("ðŸ‘ï¸ ESP")
local bringAllBtn = createButton("ðŸŽ¯ Bring ALL")

local nameBox = Instance.new("TextBox", frame)
nameBox.Size = UDim2.new(0.9, 0, 0, 40)
nameBox.PlaceholderText = "Nom joueur"
nameBox.BackgroundColor3 = Color3.fromRGB(30, 80, 150)
nameBox.TextColor3 = Color3.new(1, 1, 1)
nameBox.BorderSizePixel = 0

local bringBtn = createButton("ðŸ“ Bring 1 joueur")
local tpBtn = createButton("ðŸš¶ TP vers joueur")

local speedBox = Instance.new("TextBox", frame)
speedBox.Size = UDim2.new(0.9, 0, 0, 40)
speedBox.PlaceholderText = "WalkSpeed (ex: 32)"
speedBox.BackgroundColor3 = Color3.fromRGB(30, 80, 150)
speedBox.TextColor3 = Color3.new(1, 1, 1)
speedBox.BorderSizePixel = 0

local speedBtn = createButton("âš¡ Set Speed")
local jumpBtn = createButton("â˜ï¸ Infinite Jump OFF")

-- Fly functionality
local flying = false
local ctrl = {f=0,b=0,l=0,r=0}
local bv, bg

local function startFly()
	local char = player.Character
	if not char then return end
	local root = char:WaitForChild("HumanoidRootPart")
	bg = Instance.new("BodyGyro", root)
	bg.P = 9e4
	bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	bg.CFrame = root.CFrame
	bv = Instance.new("BodyVelocity", root)
	bv.Velocity = Vector3.new()
	bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	flying = true
	RS:BindToRenderStep("UltraFly", Enum.RenderPriority.Character.Value + 1, function()
		local cam = workspace.CurrentCamera
		bv.Velocity = (cam.CFrame.LookVector * (ctrl.f + ctrl.b) + cam.CFrame.RightVector * (ctrl.r + ctrl.l)) * 80
		bg.CFrame = cam.CFrame
	end)
end

local function stopFly()
	flying = false
	RS:UnbindFromRenderStep("UltraFly")
	if bv then bv:Destroy() end
	if bg then bg:Destroy() end
end

UIS.InputBegan:Connect(function(i, g)
	if g then return end
	if i.KeyCode == Enum.KeyCode.V then
		if flying then stopFly() else startFly() end
	elseif i.KeyCode == Enum.KeyCode.W then ctrl.f = 1
	elseif i.KeyCode == Enum.KeyCode.S then ctrl.b = -1
	elseif i.KeyCode == Enum.KeyCode.A then ctrl.l = -1
	elseif i.KeyCode == Enum.KeyCode.D then ctrl.r = 1
	end
end)

UIS.InputEnded:Connect(function(i)
	if i.KeyCode == Enum.KeyCode.W then ctrl.f = 0
	elseif i.KeyCode == Enum.KeyCode.S then ctrl.b = 0
	elseif i.KeyCode == Enum.KeyCode.A then ctrl.l = 0
	elseif i.KeyCode == Enum.KeyCode.D then ctrl.r = 0
	end
end)

flyBtn.MouseButton1Click:Connect(function()
	if flying then stopFly() else startFly() end
end)

-- ESP
local espEnabled = false
espBtn.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
			local head = p.Character.Head
			local tag = head:FindFirstChild("UltraESP")
			if tag then
				tag:Destroy()
			elseif espEnabled then
				local gui = Instance.new("BillboardGui", head)
				gui.Name = "UltraESP"
				gui.Size = UDim2.new(0, 100, 0, 40)
				gui.StudsOffset = Vector3.new(0, 2, 0)
				gui.AlwaysOnTop = true
				local label = Instance.new("TextLabel", gui)
				label.Size = UDim2.new(1, 0, 1, 0)
				label.BackgroundTransparency = 1
				label.Text = p.Name
				label.TextScaled = true
				label.Font = Enum.Font.GothamBold
				label.TextColor3 = Color3.fromRGB(255, 0, 0)
			end
		end
	end
end)

-- Bring All
bringAllBtn.MouseButton1Click:Connect(function()
	local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not root then return end
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			p.Character.HumanoidRootPart.CFrame = root.CFrame + Vector3.new(0, 5, 0)
		end
	end
end)

-- Bring one player (pseudo from textbox)
bringBtn.MouseButton1Click:Connect(function()
	local target = Players:FindFirstChild(nameBox.Text)
	if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
		local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if root then
			target.Character.HumanoidRootPart.CFrame = root.CFrame + Vector3.new(0, 5, 0)
		end
	end
end)

-- TP to player (pseudo from textbox)
tpBtn.MouseButton1Click:Connect(function()
	local target = Players:FindFirstChild(nameBox.Text)
	if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
		local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if root then
			root.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0, 3, 0)
		end
	end
end)

-- Speed changer
speedBtn.MouseButton1Click:Connect(function()
	local speed = tonumber(speedBox.Text)
	if speed and player.Character then
		local hum = player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum.WalkSpeed = speed end
	end
end)

-- Infinite Jump
local infiniteJump = false
jumpBtn.MouseButton1Click:Connect(function()
	infiniteJump = not infiniteJump
	jumpBtn.Text = infiniteJump and "â˜ï¸ Infinite Jump ON" or "â˜ï¸ Infinite Jump OFF"
end)

UIS.JumpRequest:Connect(function()
	if infiniteJump and player.Character then
		local hum = player.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)


local function getPlayerTeam(p)
    local tv = p:FindFirstChild("Team") or (p.Character and p.Character:FindFirstChild("Team"))
    if tv and tv:IsA("StringValue") then return tv.Value elseif p.Team then return tostring(p.Team) end
    return nil
end

local localTeam = getPlayerTeam(player)
local aimbotConn
local function getClosestEnemy()
    local closest, bestDist = nil, math.huge
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local humanoid = p.Character:FindFirstChildOfClass("Humanoid")
            local head = p.Character:FindFirstChild("Head")
            if humanoid and humanoid.Health > 0 and head and getPlayerTeam(p) ~= localTeam then
                local pos2d, on = camera:WorldToViewportPoint(head.Position)
                if on then
                    local d = (Vector2.new(pos2d.X,pos2d.Y) - Vector2.new(UserInputService:GetMouseLocation())).Magnitude
                    if d < bestDist then bestDist, closest = d, p end
                end
            end
        end
    end
    return closest
end

local function toggleAimbot(state)
    aimbotEnabled = state
    if state then
        aimbotConn = RunService.RenderStepped:Connect(function()
            local tgt = getClosestEnemy()
            if tgt and tgt.Character then
                local head = tgt.Character:FindFirstChild("Head")
                if head then camera.CFrame = CFrame.new(camera.CFrame.Position, head.Position) end
            end
        end)
    elseif aimbotConn then aimbotConn:Disconnect() aimbotConn = nil end
end
